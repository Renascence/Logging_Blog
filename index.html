<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="讲道理此处应有描述，可是我不讲道理。">
<meta property="og:type" content="website">
<meta property="og:title" content="Logging的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Logging的博客">
<meta property="og:description" content="讲道理此处应有描述，可是我不讲道理。">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Logging的博客">
<meta name="twitter:description" content="讲道理此处应有描述，可是我不讲道理。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Logging的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Logging的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">https://github.com/Renascence</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/28/聊聊Antd-Form表单/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/28/聊聊Antd-Form表单/" itemprop="url">聊聊Antd Form表单</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-28T13:10:37+08:00">
                2020-03-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Antd-Form"><a href="#Antd-Form" class="headerlink" title="Antd Form"></a>Antd Form</h1><p>ant design的表单相信大家都已经很熟悉了，今天聊聊其中几个api都具体实现。</p>
<hr>
<p>先来看一个demo：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class NormalLoginForm extends React.Component &#123;</span><br><span class="line">  handleSubmit = e =&gt; &#123;this.props.form.validateFields((err, values) =&gt; &#123;&#125;);&#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; getFieldDecorator &#125; = this.props.form;</span><br><span class="line">    return (</span><br><span class="line">      &lt;Form onSubmit=&#123;this.handleSubmit&#125; className=&quot;login-form&quot;&gt;</span><br><span class="line">        &lt;Form.Item&gt;</span><br><span class="line">          &#123;getFieldDecorator(&apos;username&apos;, &#123;</span><br><span class="line">            rules: [&#123; required: true, message: &apos;Please input your username!&apos; &#125;],</span><br><span class="line">          &#125;)(</span><br><span class="line">            &lt;Input</span><br><span class="line">              prefix=&#123;&lt;Icon type=&quot;user&quot; style=&#123;&#123; color: &apos;rgba(0,0,0,.25)&apos; &#125;&#125; /&gt;&#125;</span><br><span class="line">              placeholder=&quot;Username&quot;</span><br><span class="line">            /&gt;,</span><br><span class="line">          )&#125;</span><br><span class="line">        &lt;/Form.Item&gt;</span><br><span class="line">        &lt;Form.Item&gt;</span><br><span class="line">          &#123;getFieldDecorator(&apos;password&apos;, &#123;</span><br><span class="line">            rules: [&#123; required: true, message: &apos;Please input your Password!&apos; &#125;],</span><br><span class="line">          &#125;)(</span><br><span class="line">            &lt;Input</span><br><span class="line">              prefix=&#123;&lt;Icon type=&quot;lock&quot; style=&#123;&#123; color: &apos;rgba(0,0,0,.25)&apos; &#125;&#125; /&gt;&#125;</span><br><span class="line">              type=&quot;password&quot;</span><br><span class="line">            /&gt;,</span><br><span class="line">          )&#125;</span><br><span class="line">        &lt;/Form.Item&gt;</span><br><span class="line">        &lt;Form.Item&gt;</span><br><span class="line">          &lt;Button type=&quot;primary&quot; htmlType=&quot;submit&quot; className=&quot;login-form-button&quot;&gt;</span><br><span class="line">            Log in</span><br><span class="line">          &lt;/Button&gt;</span><br><span class="line">        &lt;/Form.Item&gt;</span><br><span class="line">      &lt;/Form&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">const WrappedNormalLoginForm = Form.create(&#123; name: &apos;normal_login&apos; &#125;)(NormalLoginForm);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;WrappedNormalLoginForm /&gt;, mountNode);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/formdemo.jpg" alt="Demo"></p>
<p>其中主要的几个api是 Form.creat， getFieldDecorator, form.validateFields。</p>
<p>先看最外层的 Form.creat,这个方法创造了一个高阶组件，给传入的组件props上传入了一些方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import createDOMForm from &apos;rc-form/lib/createDOMForm&apos;;</span><br><span class="line"></span><br><span class="line">export default class Form extends React.Component&lt;FormProps, any&gt; &#123;</span><br><span class="line">  …  </span><br><span class="line">  static create = function create(options = &#123;&#125;) &#123; </span><br><span class="line">    // create方法主要调用了createDOMForm函数 </span><br><span class="line">    return createDOMForm(&#123;</span><br><span class="line">      fieldNameProp: &apos;id&apos;,</span><br><span class="line">      …options,</span><br><span class="line">      fieldMetaProp: FIELD_META_PROP,</span><br><span class="line">      fieldDataProp: FIELD_DATA_PROP,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;··</span><br><span class="line">  renderForm = (&#123; getPrefixCls &#125;: ConfigConsumerProps) =&gt; &#123; // 给formItem增加类名，用于控制样式 </span><br><span class="line">    …</span><br><span class="line">    const formClassName = classNames(</span><br><span class="line">      prefixCls,</span><br><span class="line">      &#123;</span><br><span class="line">        [`$&#123;prefixCls&#125;-horizontal`]: layout === &apos;horizontal&apos;,</span><br><span class="line">        [`$&#123;prefixCls&#125;-vertical`]: layout === &apos;vertical&apos;,</span><br><span class="line">        [`$&#123;prefixCls&#125;-inline`]: layout === &apos;inline&apos;,</span><br><span class="line">        [`$&#123;prefixCls&#125;-hide-required-mark`]: hideRequiredMark,</span><br><span class="line">      &#125;,</span><br><span class="line">      className,</span><br><span class="line">    );</span><br><span class="line">     … </span><br><span class="line">     return &lt;form &#123;...formProps&#125; className=&#123;formClassName&#125; /&gt;;</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; wrapperCol, labelAlign, labelCol, layout, colon &#125; = this.props;</span><br><span class="line">    return (</span><br><span class="line">      &lt;FormContext.Provider</span><br><span class="line">        value=&#123;&#123; wrapperCol, labelAlign, labelCol, vertical: layout === &apos;vertical&apos;, colon &#125;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ConfigConsumer&gt;&#123;this.renderForm&#125;&lt;/ConfigConsumer&gt;</span><br><span class="line">      &lt;/FormContext.Provider&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/formdemo.jpg" alt="Fields"><br>初始化完成的fieldsStore，其中fields和fieldsMeta为存储信息的对象，其他方法都是对这两个对象对读写操作。</p>
<p>fields主要用来记录每个表单项的实时数据，包含以下属性：</p>
<ul>
<li>dirty 数据是否已经改变，但未校验</li>
<li>errors 校验文案</li>
<li>name 字段名称</li>
<li>touched 数据是否更新过</li>
<li>value 字段的值</li>
<li>validating 校验状态</li>
</ul>
<p>fieldsMeta 用来记录元数据，即每个字段对应组件的配置信息：</p>
<ul>
<li>initialValue 初始值</li>
<li>name 字段的名称</li>
<li>trigger 触发数据收集的时机 默认 onChange</li>
<li>valuePropName 子节点的值的属性，例如 checkbox 应该设为 checked</li>
<li>rules 校验的规则</li>
<li>originalProps 被 getFieldDecorator() 装饰的组件的原始 props</li>
<li>validate 校验规则和触发事件</li>
</ul>
<p>然后看rc-form库里的createDOMForm方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// createDOMForm.js</span><br><span class="line">function createDOMForm(option) &#123;</span><br><span class="line">  return createBaseForm(&#123;</span><br><span class="line">    ...option,</span><br><span class="line">  &#125;, [mixin]);</span><br><span class="line">&#125;</span><br><span class="line">export default createDOMForm;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// createBaseForm.js</span><br><span class="line">getInitialState() &#123;</span><br><span class="line">  const fields = mapPropsToFields &amp;&amp; mapPropsToFields(this.props);</span><br><span class="line">  this.fieldsStore = createFieldsStore(fields || &#123;&#125;); </span><br><span class="line">  // 初始化创建fieldsStore，用于存储表单信息</span><br><span class="line">  … </span><br><span class="line">  return &#123; submitting: false &#125;;</span><br><span class="line">&#125;</span><br><span class="line">render() </span><br><span class="line">  const &#123; wrappedComponentRef, ...restProps &#125; = this.props;</span><br><span class="line">  const formProps = &#123;</span><br><span class="line">    [formPropName]: this.getForm(), </span><br><span class="line">    // 来在 formPropName默认为form，getForm方法来自`createForm.js`，注入props.form的api</span><br><span class="line">    &#123;/*</span><br><span class="line">      getForm() &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">          getFieldsValue: this.fieldsStore.getFieldsValue,</span><br><span class="line">          getFieldInstance: this.getFieldInstance,</span><br><span class="line">          setFieldsValue: this.setFieldsValue,</span><br><span class="line">          setFieldsInitialValue: this.fieldsStore.setFieldsInitialValue,</span><br><span class="line">          getFieldDecorator: this.getFieldDecorator,</span><br><span class="line">          getFieldsError: this.fieldsStore.getFieldsError,</span><br><span class="line">          isSubmitting: this.isSubmitting,</span><br><span class="line">          submit: this.submit,</span><br><span class="line">          validateFields: this.validateFields,</span><br><span class="line">          resetFields: this.resetFields,</span><br><span class="line">          ...</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    */&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  if (withRef) &#123;</span><br><span class="line">    formProps.ref = &apos;wrappedComponent&apos;;</span><br><span class="line">  &#125; else if (wrappedComponentRef) &#123;</span><br><span class="line">    formProps.ref = wrappedComponentRef;</span><br><span class="line">  &#125;</span><br><span class="line">  const props = mapProps.call(this, &#123;</span><br><span class="line">    ...formProps,</span><br><span class="line">    ...restProps,</span><br><span class="line">  &#125;);</span><br><span class="line">  return &lt;WrappedComponent &#123;...props&#125; /&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="getFieldDecorator"><a href="#getFieldDecorator" class="headerlink" title="getFieldDecorator"></a>getFieldDecorator</h3><p>这个方法帮我们做了数据对双向绑定，让组件变成了受控组件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// createBaseForm.tsx</span><br><span class="line">getFieldDecorator(name, fieldOption) &#123;</span><br><span class="line">  const props = this.getFieldProps(name, fieldOption);</span><br><span class="line">  return fieldElem =&gt; &#123;</span><br><span class="line">    this.renderFields[name] = true;</span><br><span class="line"></span><br><span class="line">    const fieldMeta = this.fieldsStore.getFieldMeta(name);</span><br><span class="line">    const originalProps = fieldElem.props;</span><br><span class="line">    fieldMeta.originalProps = originalProps;</span><br><span class="line">    fieldMeta.ref = fieldElem.ref;</span><br><span class="line">    return React.cloneElement(fieldElem, &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      …this.fieldsStore.getFieldValuePropValue(fieldMeta), </span><br><span class="line">      // &#123;value: ‘xxx’&#125;，将value注入到props上，双向绑定</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面提到，form内部状态都是维护在fields和fieldsMeta里的，那么getFieldDecorator肯定对fieldsMeta有做了处理，这一步包含在了 getFieldMeta 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">getFieldProps(name, usersFieldOption = &#123;&#125;) &#123;</span><br><span class="line">    delete this.clearedFieldMetaCache[name];</span><br><span class="line">    const fieldOption = &#123;</span><br><span class="line">      name,</span><br><span class="line">      trigger: DEFAULT_TRIGGER,</span><br><span class="line">      valuePropName: &apos;value&apos;,</span><br><span class="line">      validate: [],</span><br><span class="line">      ...usersFieldOption,</span><br><span class="line">    &#125;;</span><br><span class="line">    …</span><br><span class="line">    const fieldMeta = this.fieldsStore.getFieldMeta(name);</span><br><span class="line">    const inputProps = &#123;</span><br><span class="line">      ...this.fieldsStore.getFieldValuePropValue(fieldOption),</span><br><span class="line">      ref: this.getCacheBind(name, `$&#123;name&#125;__ref`, this.saveRef),</span><br><span class="line">    &#125;;</span><br><span class="line">    …</span><br><span class="line">    const validateRules = normalizeValidateRules(</span><br><span class="line">      validate,</span><br><span class="line">      rules,</span><br><span class="line">      validateTrigger,</span><br><span class="line">    );</span><br><span class="line">    const validateTriggers = getValidateTriggers(validateRules);</span><br><span class="line">    validateTriggers.forEach(action =&gt; &#123;</span><br><span class="line">      if (inputProps[action]) return;</span><br><span class="line">      inputProps[action] = this.getCacheBind(</span><br><span class="line">        name,</span><br><span class="line">        action,</span><br><span class="line">        this.onCollectValidate, </span><br><span class="line">        // 当组件值变化调用 onCollectValidate，写入fields   </span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">    const meta = &#123;</span><br><span class="line">      ...fieldMeta,</span><br><span class="line">      ...fieldOption,</span><br><span class="line">      validate: validateRules,</span><br><span class="line">    &#125;;</span><br><span class="line">    this.fieldsStore.setFieldMeta(name, meta);</span><br><span class="line">    …</span><br><span class="line">    // This field is rendered, record it</span><br><span class="line">    this.renderFields[name] = true;</span><br><span class="line">    return inputProps;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">getFieldProps(name, usersFieldOption = &#123;&#125;) &#123;</span><br><span class="line">    delete this.clearedFieldMetaCache[name];</span><br><span class="line">    const fieldOption = &#123;</span><br><span class="line">      name,</span><br><span class="line">      trigger: DEFAULT_TRIGGER,</span><br><span class="line">      valuePropName: &apos;value&apos;,</span><br><span class="line">      validate: [],</span><br><span class="line">      ...usersFieldOption,</span><br><span class="line">    &#125;;</span><br><span class="line">    …</span><br><span class="line">    const fieldMeta = this.fieldsStore.getFieldMeta(name);</span><br><span class="line">    const inputProps = &#123;</span><br><span class="line">      ...this.fieldsStore.getFieldValuePropValue(fieldOption),</span><br><span class="line">      ref: this.getCacheBind(name, `$&#123;name&#125;__ref`, this.saveRef),</span><br><span class="line">    &#125;;</span><br><span class="line">    …</span><br><span class="line">    const validateRules = normalizeValidateRules(</span><br><span class="line">      validate,</span><br><span class="line">      rules,</span><br><span class="line">      validateTrigger,</span><br><span class="line">    );</span><br><span class="line">    const validateTriggers = getValidateTriggers(validateRules);</span><br><span class="line">    validateTriggers.forEach(action =&gt; &#123;</span><br><span class="line">      if (inputProps[action]) return;</span><br><span class="line">      inputProps[action] = this.getCacheBind(</span><br><span class="line">        name,</span><br><span class="line">        action,</span><br><span class="line">        this.onCollectValidate, </span><br><span class="line">        // 当组件值变化调用 onCollectValidate，写入fields   </span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">    const meta = &#123;</span><br><span class="line">      ...fieldMeta,</span><br><span class="line">      ...fieldOption,</span><br><span class="line">      validate: validateRules,</span><br><span class="line">    &#125;;</span><br><span class="line">    this.fieldsStore.setFieldMeta(name, meta);</span><br><span class="line">    // 这一步把信息写入了fieldMeta对象</span><br><span class="line">    …</span><br><span class="line">    // This field is rendered, record it</span><br><span class="line">    this.renderFields[name] = true;</span><br><span class="line">    return inputProps;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="validateFields"><a href="#validateFields" class="headerlink" title="validateFields"></a>validateFields</h3><p>validateFields 方法获取表单中对值并且根据校验规则对value进行校验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">validateFields(ns, opt, cb) &#123;</span><br><span class="line">  const pending = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    const &#123; names, options &#125; = getParams(ns, opt, cb);</span><br><span class="line">    let &#123; callback &#125; = getParams(ns, opt, cb);</span><br><span class="line">    if (!callback || typeof callback === &apos;function&apos;) &#123;</span><br><span class="line">      const oldCb = callback;</span><br><span class="line">      callback = (errors, values) =&gt; &#123;</span><br><span class="line">        if (oldCb) &#123;</span><br><span class="line">          oldCb(errors, values);</span><br><span class="line">        &#125;</span><br><span class="line">        if (errors) &#123;</span><br><span class="line">          reject(&#123; errors, values &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          resolve(values);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; // 兼容 v4从回调改为promise </span><br><span class="line">    const fieldNames = names</span><br><span class="line">      ? this.fieldsStore.getValidFieldsFullName(names)</span><br><span class="line">      : this.fieldsStore.getValidFieldsName();</span><br><span class="line">    const fields = fieldNames</span><br><span class="line">      .filter(name =&gt; &#123;</span><br><span class="line">        const fieldMeta = this.fieldsStore.getFieldMeta(name);</span><br><span class="line">        return hasRules(fieldMeta.validate);</span><br><span class="line">      &#125;)</span><br><span class="line">      .map(name =&gt; &#123;</span><br><span class="line">        const field = this.fieldsStore.getField(name);</span><br><span class="line">        field.value = this.fieldsStore.getFieldValue(name);</span><br><span class="line">        return field;</span><br><span class="line">      &#125;);</span><br><span class="line">    if (!fields.length) &#123;</span><br><span class="line">      callback(null, this.fieldsStore.getFieldsValue(fieldNames));</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    return e;</span><br><span class="line">  &#125;);</span><br><span class="line">  // 从fieldsMeta中取出规则进行校验，使用 async-validator </span><br><span class="line">  this.validateFieldsInternal(</span><br><span class="line">      fields,</span><br><span class="line">      &#123;</span><br><span class="line">        fieldNames,</span><br><span class="line">        options,</span><br><span class="line">      &#125;,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">  pending.catch(e =&gt; &#123;</span><br><span class="line">    return e;</span><br><span class="line">  &#125;);</span><br><span class="line">  return pending;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/redux源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/redux源码分析/" itemprop="url">redux源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-22T16:24:43+08:00">
                2020-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-redux"><a href="#1-redux" class="headerlink" title="1. redux"></a>1. redux</h2><p>redux是开发react时最常用的状态管理库之一，一般结合react-redux使用，最近翻阅了redux的源码，发现其中有很多优秀的实现方式。</p>
<p>先从redux最常用的几个方法入手查看源码</p>
<ul>
<li>createStore</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  if (</span><br><span class="line">    (typeof preloadedState === &apos;function&apos; &amp;&amp; typeof enhancer === &apos;function&apos;) ||</span><br><span class="line">    (typeof enhancer === &apos;function&apos; &amp;&amp; typeof arguments[3] === &apos;function&apos;)</span><br><span class="line">  ) &#123;</span><br><span class="line">    throw new Error(</span><br><span class="line">      &apos;It looks like you are passing several store enhancers to &apos; +</span><br><span class="line">        &apos;createStore(). This is not supported. Instead, compose them &apos; +</span><br><span class="line">        &apos;together to a single function.&apos;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 如果第二个参数是函数类型，且没有第三个参数，就把第二个参数作为中间件 --&gt;</span><br><span class="line">  if (typeof preloadedState === &apos;function&apos; &amp;&amp; typeof enhancer === &apos;undefined&apos;) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = undefined</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 存在中间件则使用中间件处理处理createstore的返回值 --&gt;</span><br><span class="line">  if (typeof enhancer !== &apos;undefined&apos;) &#123;</span><br><span class="line">    if (typeof enhancer !== &apos;function&apos;) &#123;</span><br><span class="line">      throw new Error(&apos;Expected the enhancer to be a function.&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof reducer !== &apos;function&apos;) &#123;</span><br><span class="line">    throw new Error(&apos;Expected the reducer to be a function.&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let currentReducer = reducer</span><br><span class="line">  let currentState = preloadedState</span><br><span class="line">  let currentListeners = []</span><br><span class="line">  let nextListeners = currentListeners</span><br><span class="line">  let isDispatching = false</span><br><span class="line"></span><br><span class="line">  &lt;!-- 深拷贝一份监听器，防止在dispatch过程中调用导致bug --&gt;</span><br><span class="line">  function ensureCanMutateNextListeners() &#123;</span><br><span class="line">    if (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 常用方法，获取当前状态，没什么好多解释的 --&gt;</span><br><span class="line">  function getState() &#123;</span><br><span class="line">    if (isDispatching) &#123;</span><br><span class="line">      throw new Error(</span><br><span class="line">        &apos;You may not call store.getState() while the reducer is executing. &apos; +</span><br><span class="line">          &apos;The reducer has already received the state as an argument. &apos; +</span><br><span class="line">          &apos;Pass it down from the top reducer instead of reading it from the store.&apos;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return currentState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- subscribe方法，当store改变，调用传入的监听函数 --&gt;</span><br><span class="line">  function subscribe(listener) &#123;</span><br><span class="line">    if (typeof listener !== &apos;function&apos;) &#123;</span><br><span class="line">      throw new Error(&apos;Expected the listener to be a function.&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isDispatching) &#123;</span><br><span class="line">      throw new Error(</span><br><span class="line">        &apos;You may not call store.subscribe() while the reducer is executing. &apos; +</span><br><span class="line">          &apos;If you would like to be notified after the store has been updated, subscribe from a &apos; +</span><br><span class="line">          &apos;component and invoke store.getState() in the callback to access the latest state. &apos; +</span><br><span class="line">          &apos;See https://redux.js.org/api-reference/store#subscribelistener for more details.&apos;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let isSubscribed = true</span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">    &lt;!-- 解除订阅 --&gt;</span><br><span class="line">    return function unsubscribe() &#123;</span><br><span class="line">      if (!isSubscribed) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (isDispatching) &#123;</span><br><span class="line">        throw new Error(</span><br><span class="line">          &apos;You may not unsubscribe from a store listener while the reducer is executing. &apos; +</span><br><span class="line">            &apos;See https://redux.js.org/api-reference/store#subscribelistener for more details.&apos;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed = false</span><br><span class="line">      &lt;!-- 解除本次订阅，不影响其他的订阅调用 --&gt;</span><br><span class="line">      ensureCanMutateNextListeners()</span><br><span class="line">      const index = nextListeners.indexOf(listener)</span><br><span class="line">      nextListeners.splice(index, 1)</span><br><span class="line">      currentListeners = null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 发起action，用于改变store --&gt;</span><br><span class="line">  function dispatch(action) &#123;</span><br><span class="line">    &lt;!-- action类型校验 --&gt;</span><br><span class="line">    if (!isPlainObject(action)) &#123;</span><br><span class="line">      throw new Error(</span><br><span class="line">        &apos;Actions must be plain objects. &apos; +</span><br><span class="line">          &apos;Use custom middleware for async actions.&apos;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (typeof action.type === &apos;undefined&apos;) &#123;</span><br><span class="line">      throw new Error(</span><br><span class="line">        &apos;Actions may not have an undefined &quot;type&quot; property. &apos; +</span><br><span class="line">          &apos;Have you misspelled a constant?&apos;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isDispatching) &#123;</span><br><span class="line">      throw new Error(&apos;Reducers may not dispatch actions.&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      isDispatching = true</span><br><span class="line">      &lt;!-- 改变当前状态 --&gt;</span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      isDispatching = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 状态改变后，调用所有的订阅函数 --&gt;</span><br><span class="line">    const listeners = (currentListeners = nextListeners)</span><br><span class="line">    for (let i = 0; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      const listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 项目中比较少用到，替换原有reducer --&gt;</span><br><span class="line">  function replaceReducer(nextReducer) &#123;</span><br><span class="line">    if (typeof nextReducer !== &apos;function&apos;) &#123;</span><br><span class="line">      throw new Error(&apos;Expected the nextReducer to be a function.&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    dispatch(&#123; type: ActionTypes.REPLACE &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Interoperability point for observable/reactive libraries.</span><br><span class="line">   * @returns &#123;observable&#125; A minimal observable of state changes.</span><br><span class="line">   * For more information, see the observable proposal:</span><br><span class="line">   * https://github.com/tc39/proposal-observable</span><br><span class="line">   */</span><br><span class="line">  &lt;!-- 这个函数没有被调用，详情可以看作者的github地址 --&gt;</span><br><span class="line">  function observable() &#123;</span><br><span class="line">    const outerSubscribe = subscribe</span><br><span class="line">    return &#123;</span><br><span class="line">      /**</span><br><span class="line">       * The minimal observable subscription method.</span><br><span class="line">       * @param &#123;Object&#125; observer Any object that can be used as an observer.</span><br><span class="line">       * The observer object should have a `next` method.</span><br><span class="line">       * @returns &#123;subscription&#125; An object with an `unsubscribe` method that can</span><br><span class="line">       * be used to unsubscribe the observable from the store, and prevent further</span><br><span class="line">       * emission of values from the observable.</span><br><span class="line">       */</span><br><span class="line">      subscribe(observer) &#123;</span><br><span class="line">        if (typeof observer !== &apos;object&apos; || observer === null) &#123;</span><br><span class="line">          throw new TypeError(&apos;Expected the observer to be an object.&apos;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function observeState() &#123;</span><br><span class="line">          if (observer.next) &#123;</span><br><span class="line">            observer.next(getState())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        observeState()</span><br><span class="line">        const unsubscribe = outerSubscribe(observeState)</span><br><span class="line">        return &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        return this</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // When a store is created, an &quot;INIT&quot; action is dispatched so that every</span><br><span class="line">  // reducer returns their initial state. This effectively populates</span><br><span class="line">  // the initial state tree.</span><br><span class="line">  dispatch(&#123; type: ActionTypes.INIT &#125;)</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>combineReducers</li>
</ul>
<p>这个方法主要是用来合并多个reducer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">export default function combineReducers(reducers) &#123;</span><br><span class="line">  &lt;!-- 浅拷贝一层，并确保对象都有值 --&gt;</span><br><span class="line">  const reducerKeys = Object.keys(reducers)</span><br><span class="line">  const finalReducers = &#123;&#125;</span><br><span class="line">  for (let i = 0; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    const key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">      if (typeof reducers[key] === &apos;undefined&apos;) &#123;</span><br><span class="line">        warning(`No reducer provided for key &quot;$&#123;key&#125;&quot;`)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (typeof reducers[key] === &apos;function&apos;) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  const finalReducerKeys = Object.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  // This is used to make sure we don&apos;t warn about the same</span><br><span class="line">  // keys multiple times.</span><br><span class="line">  let unexpectedKeyCache</span><br><span class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let shapeAssertionError</span><br><span class="line">  try &#123;</span><br><span class="line">    &lt;!-- assertReducerShape 函数确保每个reducer执行都有默认返回值 --&gt;</span><br><span class="line">    assertReducerShape(finalReducers)</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return function combination(state = &#123;&#125;, action) &#123;</span><br><span class="line">    if (shapeAssertionError) &#123;</span><br><span class="line">      throw shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">      const warningMessage = getUnexpectedStateShapeWarningMessage(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      if (warningMessage) &#123;</span><br><span class="line">        warning(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let hasChanged = false</span><br><span class="line">    const nextState = &#123;&#125;</span><br><span class="line">    &lt;!-- 组装新的reducer --&gt;</span><br><span class="line">    for (let i = 0; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      const key = finalReducerKeys[i]</span><br><span class="line">      const reducer = finalReducers[key]</span><br><span class="line">      const previousStateForKey = state[key]</span><br><span class="line">      const nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      &lt;!-- 确保每个reducer执行有默认返回值 --&gt;</span><br><span class="line">      if (typeof nextStateForKey === &apos;undefined&apos;) &#123;</span><br><span class="line">        const errorMessage = getUndefinedStateErrorMessage(key, action)</span><br><span class="line">        throw new Error(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    hasChanged =</span><br><span class="line">      hasChanged || finalReducerKeys.length !== Object.keys(state).length</span><br><span class="line">    return hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>compose</li>
</ul>
<p>在看applyMiddleware函数前，先了解一下compose方法，这个方法将多个函数数组变成了循环调用，即前一个函数的执行结果作为了后一个函数的参数。(同时我也觉得这段代码是redux库中实现的最精妙的方式。)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">export default function compose(...funcs) &#123;</span><br><span class="line">  if (funcs.length === 0) &#123;</span><br><span class="line">    return arg =&gt; arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (funcs.length === 1) &#123;</span><br><span class="line">    return funcs[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return funcs.reduce((a, b) =&gt; (...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- 转为es5语法帮助理解 --&gt;</span><br><span class="line">function compose() &#123;</span><br><span class="line">  var _len = arguments.length;</span><br><span class="line">  var funcs = [];</span><br><span class="line">  for (var i = 0; i &lt; _len; i++) &#123;</span><br><span class="line">    funcs[i] = arguments[i];</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;!-- 如果没有传入参数，那么直接透传传入的参数 --&gt;</span><br><span class="line">  if (funcs.length === 0) &#123;</span><br><span class="line">    return function (arg) &#123;</span><br><span class="line">      return arg;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 如果传入了一个函数，那么直接返回该函数处理传入的参数 --&gt;</span><br><span class="line">  if (funcs.length === 1) &#123;</span><br><span class="line">    return funcs[0];</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;!-- 注意reduce函数为从右向左执行 --&gt;</span><br><span class="line">  return funcs.reduce(function (a, b) &#123;</span><br><span class="line">    return function () &#123;</span><br><span class="line">      return a(b.apply(undefined, arguments));</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举例查看compose的执行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const value=compose(function(value)&#123;</span><br><span class="line">  return value+1;</span><br><span class="line">&#125;,function(value)&#123;</span><br><span class="line">  return value*2;</span><br><span class="line">&#125;,function(value)&#123;</span><br><span class="line">  return value-3;</span><br><span class="line">&#125;)(2);</span><br><span class="line">value = -1 // （2-3）*2 +1</span><br></pre></td></tr></table></figure></p>
<ul>
<li>applyMiddleware</li>
</ul>
<p>applyMiddleware是用来处理传入中间件的函数，传入中间件是为了增强dispatch函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">export default function applyMiddleware(...middlewares) &#123;</span><br><span class="line">  return createStore =&gt; (...args) =&gt; &#123;</span><br><span class="line">    const store = createStore(...args)</span><br><span class="line">    let dispatch = () =&gt; &#123;</span><br><span class="line">      throw new Error(</span><br><span class="line">        &apos;Dispatching while constructing your middleware is not allowed. &apos; +</span><br><span class="line">          &apos;Other middleware would not be applied to this dispatch.&apos;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: (...args) =&gt; dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;!-- 先将传入的中间件都执行一遍 --&gt;</span><br><span class="line">    const chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))</span><br><span class="line">    &lt;!-- 再对执行结果调用compose方法，增强dispatch --&gt;</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redux中目前最核心的几个方法基本上都列举出来了，如果有不足和错误的地方还请建议改正。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/04/聊聊前端埋点的实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/04/聊聊前端埋点的实现/" itemprop="url">聊聊前端埋点的实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-04T13:19:24+08:00">
                2020-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近接手的需求产品需要增加埋点，以便查看上线后的效果，而公司内部有个公用的埋点库，基本原理就是请求服务器1*1像素的图片，在url后加上query参数达到埋点效果。</p>
<p>但是！测试小姐姐在某天突然和我，在控制台的network里看不到埋点触发的请求了，我打开本地开发环境，发现埋点没有问题，那么和测试环境唯一的区别就是npm包的版本不一样了（package.json中我们没有锁定版本），于是本地重新执行npm install后， 果然复现问题了。</p>
<p>按理说公用库每次发布都会经过测试，不会出现这么明显的错误呀，于是我查看了库的源码，有个特别的方法引起了我的注意。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.sendBeacon</span><br></pre></td></tr></table></figure></p>
<p>接下来我们就聊聊sendBeacon这个方法。</p>
<h2 id="navigator-sendBeacon"><a href="#navigator-sendBeacon" class="headerlink" title="navigator.sendBeacon()"></a>navigator.sendBeacon()</h2><p>语法:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.sendBeacon(url, data);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>url: 参数表明 data 将要被发送到的网络地址。</p>
</li>
<li><p>data: 参数是将要发送的 ArrayBufferView 或 Blob, DOMString 或者 FormData 类型的数据。</p>
</li>
</ul>
<p>sendBeacon主要解决的问题是异步埋点的触发时机问题。</p>
<p>例如在创建流程完成时需要触发埋点，但是创建完成后需要页面跳转至其他页面（非spa），这时候如果需要触发埋点，浏览器就会延迟执行跳转的逻辑或者请求会被cancel，影响页面性能，所以出现了sendBeacon方法。<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;unload&apos;, logData, false);</span><br><span class="line"></span><br><span class="line">function logData() &#123;</span><br><span class="line">    navigator.sendBeacon(&quot;/log&quot;, analyticsData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用 sendBeacon() 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>祝大家2020新年快乐！<br>同时尽量督促自己努力完成每月一篇博客的目标！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/25/浅析react-diff的机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/25/浅析react-diff的机制/" itemprop="url">浅析react diff的机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-25T21:15:51+08:00">
                2019-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一、 基本概念</p>
<h2 id="Real-DOM：浏览器中真实存在的节点。"><a href="#Real-DOM：浏览器中真实存在的节点。" class="headerlink" title="Real DOM：浏览器中真实存在的节点。"></a>Real DOM：浏览器中真实存在的节点。</h2><p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/RealDOM.png" alt="Real DOM"></p>
<p>Virtual dom：使用js描述Real DOM的对象。</p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/VirtualDOM.png" alt="Virtual DOM"></p>
<p>Virtual dom 转化为 Real DOM：</p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/v2r.png" alt="Virtual DOM -&gt; Real DOM"></p>
<h2 id="二、-为什么要使用Virtual-DOM"><a href="#二、-为什么要使用Virtual-DOM" class="headerlink" title="二、 为什么要使用Virtual DOM"></a>二、 为什么要使用Virtual DOM</h2><p>  从浏览器的角度来说，js执行肯定没有直接渲染html快才对，那我们为什么需要v-dom呢。先从浏览器的工作原说起：</p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/browser.png" alt="浏览器工作原理"></p>
<p>Repaint（重绘）：元素产生了不影响排版的情况下后对这个元素进行重新绘制的过程。</p>
<p>Reflow（重排）：元素产生了对文档树排版有影响的样式变化，对所有受影响的dom节点进行重新排版的过程。</p>
<p>提高网页性能，就是要降低”重排”和”重绘”的频率和成本，尽量少触发重新渲染。这就是v-dom帮我们完成的事情。<br>（Tips：所以一些对dom操作不多对页面，还是尽量使用html编写，或者对速度有要求的页面可以通过ssr实现效果。）</p>
<p>浏览器对于重排和重绘的优化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.style.color = &apos;red&apos;;</span><br><span class="line">div.style.marginTop = &apos;10px&apos; // 浏览器会合并执行，只触发一次重绘和重排</span><br></pre></td></tr></table></figure></p>
<p>浏览器无法优化的情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div.style.color = &apos;red&apos;;</span><br><span class="line">const margin = parseInt(div.style.marginTop); // 无法优化，立即进行一次重绘</span><br><span class="line">div.style.marginTop = &apos;10px&apos;</span><br></pre></td></tr></table></figure></p>
<p>面对浏览器无法优化的情况，我们就需要v-dom的帮助。</p>
<h2 id="三、-React-diff策略"><a href="#三、-React-diff策略" class="headerlink" title="三、 React diff策略"></a>三、 React diff策略</h2><ul>
<li>tree diff：Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/treeDiff.png" alt="tree diff"></p>
<ul>
<li>component diff：拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/componentDiff.png" alt="component diff"></p>
<ul>
<li><p>element diff：对于同一层级的一组子节点，它们可以通过唯一 id 进行区分。</p>
<ul>
<li>INSERT_MARKUP，新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作。 </li>
<li>MOVE_EXISTING，在老集合有新 component 类型，且 element 是可更新的类型，generateComponentChildren 已调用 receiveComponent，这种情况下 prevChild=nextChild，就需要做移动操作，可以复用以前的 DOM 节点。 </li>
<li>REMOVE_NODE，老 component 类型，在新集合里也有，但对应的 element 不同则不能直接复用和更新，需要执行删除操作，或者老 component 不在新集合里的，也需要执行删除操作。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/domChange.png" alt="domChange"></p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/domDIff.png" alt="domDIff"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/10/react-router-v4-code-split/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/10/react-router-v4-code-split/" itemprop="url">react-router v4 code split</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-10T20:38:44+08:00">
                2018-03-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为什么需要code-split"><a href="#为什么需要code-split" class="headerlink" title="为什么需要code split"></a>为什么需要code split</h2><p>现在越来越多的网页应用都变成了spa，spa的用户体验自然是比传统网页好。但是随着项目越来越大，而spa又是一次性将全部代码下载至本地，所以用户在首屏浏览的等待时间可能会过长，这时候我们就需要使用到代码分割（code split）。代码分割可以在用户跳转页面时根据路由加载对应页面的文件，这样就减小了首次下载的文件体积，缩短白屏时间。</p>
<h2 id="bundle-loader"><a href="#bundle-loader" class="headerlink" title="bundle-loader"></a>bundle-loader</h2><p>这是webpack官方用来分割代码的插件，在现有项目中使用这个插件需要如下几步操作：</p>
<ul>
<li>安装（废话。。。）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i bundle-loader --save</span><br></pre></td></tr></table></figure>
<ul>
<li>在webpack中配置插件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;</span><br><span class="line">  rules: [&#123;</span><br><span class="line">    test: /\.js$/,</span><br><span class="line">    exclude: /node_modules/,</span><br><span class="line">    loader: &apos;babel-loader&apos;, // 添加bundle-loader</span><br><span class="line">    query: &#123;</span><br><span class="line">      plugins: [</span><br><span class="line">        [&apos;import&apos;, [&#123; libraryName: &quot;antd&quot;, style: true &#125;]],</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    test: /\.css$/,</span><br><span class="line">    loader: &apos;style-loader!css-loader&apos;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    test: /\.less$/,</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: &quot;style-loader&quot;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: &quot;css-loader&quot;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: &quot;less-loader&quot;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<ul>
<li>插件的使用</li>
</ul>
<p>我们先需要定义一个组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component &#125; from &apos;react&apos;;</span><br><span class="line"></span><br><span class="line">class Bundle extends Component &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    super()</span><br><span class="line">    this.state = &#123;</span><br><span class="line">      mod: null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    this.props.load((mod) =&gt; &#123;</span><br><span class="line">      this.setState(&#123;</span><br><span class="line">        mod: mod.default || mod</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      this.state.mod ? this.props.children(this.state.mod) : null</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Bundle;</span><br></pre></td></tr></table></figure>
<p>然后在路由组件中给我们需要分割的组件做如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import Bundle from &apos;./components/bundle/Bundle&apos;;</span><br><span class="line"> &lt;div&gt;</span><br><span class="line">  &lt;Route</span><br><span class="line">    path=&quot;/&quot;</span><br><span class="line">    exact</span><br><span class="line">    render=&#123;() =&gt; (</span><br><span class="line">      &lt;Bundle load=&#123;require(&apos;bundle-loader?lazy!./components/home/Home&apos;)&#125;&gt;</span><br><span class="line">        &#123;Home =&gt; &lt;Home /&gt;&#125;</span><br><span class="line">      &lt;/Bundle&gt;)</span><br><span class="line">    &#125;</span><br><span class="line">  /&gt;</span><br><span class="line">   &lt;Route</span><br><span class="line">    path=&quot;/movieDetail/:id&quot;</span><br><span class="line">    exact</span><br><span class="line">    render=&#123;props =&gt; ( // 如果需要route组件提供相关的props则需要传入此参数</span><br><span class="line">      &lt;Bundle load=&#123;require(&apos;bundle-loader?lazy!./components/movieDetail/MovieDetail&apos;)&#125;&gt;</span><br><span class="line">        &#123;MovieDetail =&gt; &lt;MovieDetail &#123;...props&#125; /&gt;&#125;</span><br><span class="line">      &lt;/Bundle&gt;)</span><br><span class="line">    &#125;</span><br><span class="line">  /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>接下来执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure></p>
<p>就可以看到代码成功被分割的情况啦～<br>  <img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/codeSplit.png" alt="分割代码后打包效果"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/es6常用特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/30/es6常用特性/" itemprop="url">es6常用特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-30T22:18:31+08:00">
                2018-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用es6语法开发也有一年多了，总结一下es6中常用的一些技巧。</p>
<h2 id="1-解构与展开运算符"><a href="#1-解构与展开运算符" class="headerlink" title="1. 解构与展开运算符"></a>1. 解构与展开运算符</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const student = &#123;</span><br><span class="line">  name: &apos;xiaoming&apos;,</span><br><span class="line">  id: 1,</span><br><span class="line">  age: 23,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在es5中想去除student中的变量，需要这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const name = student.name, id=student.id, age=student.age</span><br></pre></td></tr></table></figure>
<p>这样的代码过于繁琐，我们可以使用es6的解构语法来优化它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const &#123;name , age, id&#125; = student</span><br></pre></td></tr></table></figure>
<p>展开运算符和解构结合使用也能简化部分代码，比如student这个对象中有3个属性值，现在需要其中除去name剩下的2个字段组成新的对象，可以这么做</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const &#123;name, ...rest&#125; = student</span><br><span class="line">rest // &#123;age: 23, id:1&#125; 注意：此操作为深拷贝</span><br></pre></td></tr></table></figure>
<p>展开运算符在开发中使用最多的还是要数redux了，不使用展开运算符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function todoApp(state = initialState, action) &#123;</span><br><span class="line">  switch (action.type) &#123;</span><br><span class="line">    case SET_VISIBILITY_FILTER:</span><br><span class="line">      return Object.assign(&#123;&#125;, state, &#123;</span><br><span class="line">        visibilityFilter: action.filter</span><br><span class="line">      &#125;)</span><br><span class="line">    default:</span><br><span class="line">      return state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function todoApp(state = initialState, action) &#123;</span><br><span class="line">  switch (action.type) &#123;</span><br><span class="line">    case SET_VISIBILITY_FILTER:</span><br><span class="line">      return &#123; ...state, visibilityFilter: action.filter &#125;</span><br><span class="line">    default:</span><br><span class="line">      return state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>替换了Object.assign方法，代码更简洁。</p>
<p>小技巧：使用解构交换两个变量的值:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a,b] = [b,a]</span><br></pre></td></tr></table></figure></p>
<p>最早看到这种操作方式是在Python中，现在es6也支持了。<br>第一次看到这个代码惊为天人，省去了中间变量的声明，把三行代码缩减至一行，确实是很实用的功能。</p>
<h2 id="2-arrow-funtion"><a href="#2-arrow-funtion" class="headerlink" title="2. arrow funtion"></a>2. arrow funtion</h2><p>箭头函数简化了function语法，同时解决了this指向问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function Person() &#123;</span><br><span class="line">  this.age = 0;</span><br><span class="line">  setInterval(function() &#123;</span><br><span class="line">    this.age // 非严格模式指向window对象</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在箭头函数出现之前我们一般这么解决问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function Person() &#123;</span><br><span class="line">  var that = this;</span><br><span class="line">  that.age = 0;</span><br><span class="line">  setInterval(function() &#123;</span><br><span class="line">    that.age++; // 在外部申明变量指向this，在函数内部调用</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>借助箭头函数，我们可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function Person()&#123;</span><br><span class="line">  this.age = 0;</span><br><span class="line">  setInterval(() =&gt; &#123;</span><br><span class="line">    this.age++;</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外，箭头函数中的this不会被call/bind改变指向。</p>
<p>箭头函数不绑定arguments对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const arguments = 42;</span><br><span class="line">const arr = () =&gt; arguments; </span><br><span class="line">arr() // 42 全部变量 可以使用剩余参数方式访问传入参数</span><br></pre></td></tr></table></figure></p>
<h2 id="3-函数默认参数"><a href="#3-函数默认参数" class="headerlink" title="3. 函数默认参数"></a>3. 函数默认参数</h2><p>在es5中，对传入参数判断一般这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function multiply(a,b) &#123;</span><br><span class="line">  b = (typeof b !== &apos;undefined&apos;) ?  b : 1;</span><br><span class="line">  return a * b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>借助默认参数，可以改写成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function multiply(a, b = 1) &#123; // 默认参数</span><br><span class="line">  return a * b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-Promise"><a href="#4-Promise" class="headerlink" title="4. Promise"></a>4. Promise</h2><p>Promise 解决了es5中回调地狱的问题，让代码逻辑变得更加直观。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const promise = new Promise((resolve,reject)=&gt; &#123;</span><br><span class="line">  setTimeout(() =&gt; &#123; // 创建异步任务</span><br><span class="line">    if(data) &#123;</span><br><span class="line">      resolve(data) // 正常返回数据</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      reject(err) // 异常</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 指定回调函数</span><br><span class="line">promise.then(res =&gt; &#123;</span><br><span class="line">  console.log(res)  // 监听成功的回调</span><br><span class="line">&#125;).catch(err =&gt; &#123;</span><br><span class="line">  console.log(err)  // 监听错误的回调</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>为了让代码看上去更简洁，通常还会使用es7规范中的async/await语法（通过webpakck插件转译）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">async function getData(url)&#123;</span><br><span class="line">  return fetch(url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">  const data = await getData(url)</span><br><span class="line">&#125; catch(err) &#123;</span><br><span class="line">  console.log(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 如果有多个互不依赖的请求可以使用promise.all提升效率</span><br><span class="line">const [res1,res2,res3] = await Promise.all([getData1,getData2,getData3])</span><br></pre></td></tr></table></figure>
<h2 id="5-fetch"><a href="#5-fetch" class="headerlink" title="5. fetch"></a>5. fetch</h2><p>在过去浏览器发起请求都是ajax,现在可以使用新的api fetch。<br>准确来说 fetch 应该属于es7的标准,但是大部分浏览器都已经支持,而且这个特性我使用比较多很方便,所以一起列出来。<br>fetch返回的是promise对象,可以直接使用then和catch方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 默认为get </span><br><span class="line">fetch(url)</span><br><span class="line">.then((response) =&gt; &#123;</span><br><span class="line">  console.log(response)</span><br><span class="line">&#125;)</span><br><span class="line">.catch((err) =&gt; &#123;</span><br><span class="line">  console.log(err)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 设置post请求参数</span><br><span class="line">const option = &#123;</span><br><span class="line">  method: &apos;POST&apos;,</span><br><span class="line">  body: &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">fetch(url, option)</span><br><span class="line">.then((response) =&gt; &#123;</span><br><span class="line">  console.log(response)</span><br><span class="line">&#125;)</span><br><span class="line">.catch((err) =&gt; &#123;</span><br><span class="line">  console.log(err)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意: </p>
<ul>
<li>Fetch 请求默认是不带 cookie 的，需要设置 fetch(url, {credentials: ‘include’})</li>
<li>服务器返回 400，500 错误码时并不会 reject，只有网络错误这些导致请求不能完成时，fetch 才会被 reject。</li>
</ul>
<h2 id="6-const-和-let"><a href="#6-const-和-let" class="headerlink" title="6. const 和 let"></a>6. const 和 let</h2><p>在es5中，只有函数作用域和全局作用域的概念，es6中新引入了块级作用域的概念。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  let a = 1;</span><br><span class="line">&#125;</span><br><span class="line">a // Uncaught ReferenceError: a is not defined</span><br></pre></td></tr></table></figure></p>
<p>var申明的变量存在变量提升，const和let不存在。</p>
<p>对于简单类型，使用const 定义常量，使用let 定义变量。</p>
<p>对于复杂类型来说，都应该使用const 定义。</p>
<p>使用const声明的复杂类型保证了变量的类型不会改变,但是不能保证复杂元素中的值不被改变。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const a = &#123;b:1&#125;</span><br><span class="line">a = 1  // Uncaught TypeError: Assignment to constant variable.</span><br><span class="line">a.b = 2</span><br><span class="line">a //  &#123;b:2&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/03/js模块化中的AMD和CMD规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/03/js模块化中的AMD和CMD规范/" itemprop="url">js模块化中的AMD和CMD规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-03T23:30:11+08:00">
                2017-12-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上篇文章中说了在node环境中，各个模块基本上都是已经存储在硬盘上可以直接调用，但是在浏览器环境下，各个模块加载的时间和顺序都不一样，CommonJS是不适用的，所以适用于浏览器环境的模块规范 AMD 和 CMD 就诞生了。</p>
<h3 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h3><p>AMD模块推荐使用写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define(&quot;alpha&quot;, [&quot;require&quot;, &quot;exports&quot;, &quot;beta&quot;], function (require, exports, beta) &#123;</span><br><span class="line">  exports.verb = function() &#123;</span><br><span class="line">    return beta.verb();</span><br><span class="line">    return require(&quot;beta&quot;).verb();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在define函数中，第一个参数指定了当前模块的id，第二个参数指定了该模块需要用到哪些依赖，第三个参数为模块本身。</p>
<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>CMD推荐写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define(id, function(require, exports, module) &#123;</span><br><span class="line">  // 获取模块 a 的接口</span><br><span class="line">  var a = require(&apos;./a&apos;);</span><br><span class="line"></span><br><span class="line">  // 调用模块 a 的方法</span><br><span class="line">  a.doSomething();</span><br><span class="line"></span><br><span class="line">  exports.doSomething = function() &#123;&#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>第一个参数是本模块的id，第二个参数为一个函数，里面需要指明依赖的模块和导出的内容。</p>
<p>通过以上代码，我们可以看出两者使用方式的区别，AMD需要提前声明依赖的模块，而CMD则是依赖就近，使用前才声明。</p>
<p>虽然RequireJS（AMD）和SeaJS（CMD）在使用时不使用推荐写法也能工作，但是为了避免出现奇怪的问题（例如执行顺序），最好还是按照推荐写法实现。</p>
<h3 id="我在项目中常用的模块机制"><a href="#我在项目中常用的模块机制" class="headerlink" title="我在项目中常用的模块机制"></a>我在项目中常用的模块机制</h3><p>现在我们使用的最多的开发环境就是webpack + babel了，在开发时，通常直接使用import，但是为了考虑浏览器的兼容情况，babel通常把模块转换为CommonJS规范的模块。</p>
<p>参考链接：</p>
<p><a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank" rel="noopener">AMD模块规范</a><br><a href="https://github.com/seajs/seajs/issues/242" target="_blank" rel="noopener">CMD模块规范</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/18/js模块化中的CommonJS规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/18/js模块化中的CommonJS规范/" itemprop="url">js模块化中的CommonJS规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-18T22:42:25+08:00">
                2017-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>说起js的模块化，现在很方便的联想到require/import等方式，然而最初js是没有模块这个概念的，不同js文件之间的相互引用依赖于在html中通过 script 标签引入文件，才能相互使用其中的方法。后来随着技术发展，缺少模块化的js使用实在不便，于是模块化规范诞生了。</p>
<h3 id="CommonJS"><a href="#CommonJS" class="headerlink" title="CommonJS"></a>CommonJS</h3><p>  CommonJS定义了js模块之间相互引用的规范（主要是非浏览器环境中，node.js采用的就是此规范）。CommonJS规定每个模块内部，module变量代表当前模块。这个变量是一个对象，它的exports属性（即module.exports）是对外的接口。加载某个模块，其实是加载该模块的module.exports属性。</p>
<p>  CommonJS 加载模块是同步的，只有加载完成才能执行后面的操作。像Node.js依赖的模块基本都是存在硬盘上，加载起来比较快，不用考虑异步加载的方式，所以CommonJS规范比较适用。</p>
<p>  CommonJS模块导入导出使用 module.exports 和 require 方法，经过包装后的模块相当于<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function(exports, require, module, __filename, __dirname)&#123;</span><br><span class="line">  // code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  可以看出，经过以上的包装方式，所有在文件内部声明的变量如果没有被放在 exports 对象中，其他文件是无法获取到该变量的，如果想获取该变量，需要通过如下方式声明一个全局变量：<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global.attr = true;</span><br></pre></td></tr></table></figure></p>
<p>  所有模块都是Module的实例。module具有以下基本属性</p>
<ul>
<li>module.id 模块的识别符，通常是带有绝对路径的模块文件名。</li>
<li>module.filename 模块的文件名，带有绝对路径。</li>
<li>module.loaded 返回一个布尔值，表示模块是否已经完成加载。</li>
<li>module.parent 返回一个对象，表示调用该模块的模块。</li>
<li>module.children 返回一个数组，表示该模块要用到的其他模块。</li>
<li><p>module.exports 表示模块对外输出的值。</p>
<p>// TODO 突然想起之前公司有个老司机提出过‘两个模块相互引用会不会死锁’的问题，带我研究一番回来继续填坑。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/13/记第一次遇到图片防盗链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/13/记第一次遇到图片防盗链/" itemprop="url">记第一次遇到图片防盗链</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-13T23:54:05+08:00">
                2017-10-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>豆瓣电影这个app我用了很久，但是最近突然改版了，个人觉得ui没有原来好看，刚好豆瓣实验室提供了必须的api，所以打算自己写个项目展示一些电影数据。</p>
<hr>
<p>豆瓣实验室提供的api很不错，相当一部分的数据都能找到了，但是开发的第一天就遇到了问题————图片盗链。</p>
<p>api返回数据中包含了电影的海报url，当我把img元素的src指向url时，服务器却返回了403。</p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/douban403.png" alt="请求图片403错误"></p>
<p>说实话，403这个报错之前开发我一直没遇到过，正好学习一下。</p>
<h3 id="http-请求头中的-referer"><a href="#http-请求头中的-referer" class="headerlink" title="http 请求头中的 referer"></a>http 请求头中的 referer</h3><blockquote>
<p>HTTP参照位址（referer，或HTTP referer）是HTTP表头的一个栏位，用来表示从哪儿连结到目前的网页，採用的格式是URL。换句话说，藉着HTTP参照位址，目前的网页可以检查访客从哪裡而来，这也常被用来对付伪造的跨网站请求。</p>
</blockquote>
<p>然后对照我发起请求的时候带的referer</p>
<p><img src="https://raw.githubusercontent.com/Renascence/Renascence.github.io/hexo/source/_posts/img/referer.png" alt="referer"></p>
<p>我用webpack开发，端口设置的是7000，所以referer信息显示的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer:http://localhost:7000/</span><br></pre></td></tr></table></figure>
<p>找到问题所在了，看上去只要把请求中的referer改掉就行了。然而经过我多次的查阅资料，发现是无法从前端修改referer的，只能换个思路：</p>
<ol>
<li><p>搭建node服务器，请求前端请求发给node，由node转发伪造referer。</p>
</li>
<li><p>根据api返回的图片url下载到本地访问。</p>
</li>
</ol>
<p>因为目前只打算在ghpages上写一个静态页面，所以选择了第二种解决方案，写了一个<a href="https://github.com/Renascence/movieData/blob/master/src/utils/getImages.js" target="_blank" rel="noopener">脚本</a></p>
<p>并把这个脚本加到package.json中去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;start&quot;: &quot;node src/utils/getImages.js &amp;&amp; webpack-dev-server --content-base --inline --hot --open&quot;,</span><br></pre></td></tr></table></figure>
<p>这样每次开发启动服务都会更新一下本地下载的图片。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/27/记一次失败的折腾/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Logging">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Logging的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/27/记一次失败的折腾/" itemprop="url">记一次失败的折腾</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-27T18:22:42+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  最近突然闲下来，打算折腾折腾linux桌面玩玩。<br>  嗯，然后由于开启了compiz的部分特性产生冲突，然后图形桌面变得不稳定。</p>
<p>  <strong>小事重启，大事重装</strong></p>
<p>  于是我重装了一下系统。</p>
<p>  先备份数据。我把硬盘上的部分数据，甚至包括.bashrc和编辑器的快捷键代码文件都备份下来了。</p>
<p>  当我看到我的博客项目的时候，我稍微想了一下， ————都托管在github上呢，就不备份了吧。</p>
<p>  然而，我完全没有意识到，github上托管的博客是hexo从markdown生成的html。</p>
<p>  ————是的，现在你看到的博客就是我html转成markdown然后由hexo再次生成的html。</p>
<p>  心累.jpg</p>
<p>  吃一堑长一智，所以这次在github上多开了一个分支，来保存markdown文件。</p>
<p>  所以我现在把这件事记录下来，提醒自己：折腾有风险，装机需谨慎。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Logging</p>
              <p class="site-description motion-element" itemprop="description">讲道理此处应有描述，可是我不讲道理。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Logging</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
