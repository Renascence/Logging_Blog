---
title: 聊聊前端埋点的实现
date: 2020-01-04 13:19:24
tags:
---

最近接手的需求产品需要增加埋点，以便查看上线后的效果，而公司内部有个公用的埋点库，基本原理就是请求服务器1*1像素的图片，在url后加上query参数达到埋点效果。

但是！测试小姐姐在某天突然和我，在控制台的network里看不到埋点触发的请求了，我打开本地开发环境，发现埋点没有问题，那么和测试环境唯一的区别就是npm包的版本不一样了（package.json中我们没有锁定版本），于是本地重新执行npm install后， 果然复现问题了。

按理说公用库每次发布都会经过测试，不会出现这么明显的错误呀，于是我查看了库的源码，有个特别的方法引起了我的注意。
```
  navigator.sendBeacon
```
接下来我们就聊聊sendBeacon这个方法。

## navigator.sendBeacon()

语法:  

```
  navigator.sendBeacon(url, data);
```

- url: 参数表明 data 将要被发送到的网络地址。

- data: 参数是将要发送的 ArrayBufferView 或 Blob, DOMString 或者 FormData 类型的数据。


sendBeacon主要解决的问题是异步埋点的触发时机问题。

例如在创建流程完成时需要触发埋点，但是创建完成后需要页面跳转至其他页面（非spa），这时候如果需要触发埋点，浏览器就会延迟执行跳转的逻辑或者请求会被cancel，影响页面性能，所以出现了sendBeacon方法。
例如：
```
  window.addEventListener('unload', logData, false);

  function logData() {
      navigator.sendBeacon("/log", analyticsData);
  }
```

使用 sendBeacon() 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。

## 结语

祝大家2020新年快乐！
同时尽量督促自己努力完成每月一篇博客的目标！